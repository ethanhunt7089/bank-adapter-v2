================================================================================
                    PAYMENT GATEWAY SYSTEM DOCUMENTATION
================================================================================

‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 30 ‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2025
‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 1.0
‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤

================================================================================
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏ö‡∏ö
================================================================================

‡∏£‡∏∞‡∏ö‡∏ö Payment Gateway ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bank-adapter ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö BIB-Pay ‡πÅ‡∏•‡∏∞ Easy-Pay
‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Strategy Pattern Design Pattern

================================================================================
                                ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°
================================================================================

CAS ‚Üí bank-adapter ‚Üí Payment Gateway Service
                    ‚îú‚îÄ‚îÄ BIB-Pay Service (Deposit + Withdraw)
                    ‚îî‚îÄ‚îÄ Easy-Pay Service (Deposit + Withdraw)

================================================================================
                                FLOW ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
================================================================================

1. DEPOSIT FLOW
   CAS ‚Üí bank-adapter ‚Üí Payment Gateway ‚Üí BIB-Pay/Easy-Pay
   ‚Üì
   Payment Gateway ‚Üí Webhook ‚Üí bank-adapter ‚Üí CAS (callbackUrl)

2. WITHDRAW FLOW
   CAS ‚Üí bank-adapter ‚Üí Payment Gateway ‚Üí BIB-Pay/Easy-Pay
   ‚Üì
   Payment Gateway ‚Üí Webhook ‚Üí bank-adapter ‚Üí CAS (callbackUrl)

================================================================================
                                API SPECIFICATIONS
================================================================================

1. CREATE DEPOSIT
   Endpoint: POST /api/create-deposit
   Payload:
   {
     "accountName": "string",      // ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
     "bankNumber": "string",       // ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
     "bankCode": "string",         // ‡∏£‡∏´‡∏±‡∏™‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
     "refCode": "string",          // ‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (transaction_id)
     "amount": "number",           // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
     "callbackUrl": "string",      // URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö callback
     "gatewayType": "string"       // 'bibpay' ‡∏´‡∏£‡∏∑‡∏≠ 'easypay'
   }

2. CREATE WITHDRAW
   Endpoint: POST /api/create-withdraw
   Payload: (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô deposit)

3. WEBHOOK ENDPOINTS
   POST /api/webhooks/bibpay
   POST /api/webhooks/easypay

================================================================================
                                PAYMENT GATEWAYS
================================================================================

1. BIB-PAY
   - Base URL: https://bibpay-api-wahja.ondigitalocean.app
   - Authentication: API Key (x-api-key)
   - Deposit: POST /api/v1/mc/payin
   - Withdraw: POST /api/v1/mc/payout
   - Balance: POST /api/v1/mc/balance
   - Banks: POST /api/v1/mc/bank

2. EASY-PAY
   - Base URL: https://api.bibbyx.com
   - Authentication: Bearer Token
   - Deposit: POST /api/v1/cs/deposit
   - Withdraw: POST /api/v1/cs/withdraw
   - ‡πÑ‡∏°‡πà‡∏°‡∏µ Balance ‡πÅ‡∏•‡∏∞ Banks API

================================================================================
                                DATABASE SCHEMA
================================================================================

1. PAYMENT_DEPOSITS
   - id: UUID (Primary Key)
   - ref_code: VARCHAR(100) UNIQUE NOT NULL
   - amount: DECIMAL(15,2) NOT NULL
   - deposit_amount: DECIMAL(15,2) NOT NULL
   - account_name: VARCHAR(100) NOT NULL
   - bank_number: VARCHAR(50) NOT NULL
   - bank_code: VARCHAR(10) NOT NULL
   - callback_url: TEXT NOT NULL
   - signature: VARCHAR(255)
   - api_key: VARCHAR(255)
   - gateway_type: VARCHAR(20) NOT NULL
   - status: VARCHAR(20) DEFAULT 'pending'
   - qr_code: TEXT
   - created_at: TIMESTAMP
   - updated_at: TIMESTAMP
   - timeout_at: TIMESTAMP
   - completed_at: TIMESTAMP

2. PAYMENT_WITHDRAWALS
   - id: UUID (Primary Key)
   - ref_code: VARCHAR(100) UNIQUE NOT NULL
   - amount: DECIMAL(15,2) NOT NULL
   - account_name: VARCHAR(100) NOT NULL
   - bank_number: VARCHAR(50) NOT NULL
   - bank_code: VARCHAR(10) NOT NULL
   - callback_url: TEXT NOT NULL
   - signature: VARCHAR(255)
   - api_key: VARCHAR(255)
   - gateway_type: VARCHAR(20) NOT NULL
   - status: VARCHAR(20) DEFAULT 'pending'
   - created_at: TIMESTAMP
   - updated_at: TIMESTAMP
   - completed_at: TIMESTAMP

3. PAYMENT_WEBHOOKS
   - id: UUID (Primary Key)
   - ref_code: VARCHAR(100) NOT NULL
   - transaction_type: VARCHAR(20) NOT NULL
   - gateway_type: VARCHAR(20) NOT NULL
   - webhook_data: JSONB NOT NULL
   - status: VARCHAR(20) DEFAULT 'received'
   - processed_at: TIMESTAMP
   - created_at: TIMESTAMP

================================================================================
                                STRATEGY PATTERN
================================================================================

1. INTERFACE
   interface IPaymentGateway {
     createDeposit(payload: CreateDepositPayload): Promise<DepositResponse>;
     createWithdraw(payload: CreateWithdrawPayload): Promise<WithdrawResponse>;
     handleWebhook(webhookData: any): Promise<void>;
   }

2. CONCRETE STRATEGIES
   - BibPayStrategy: implements IPaymentGateway
   - EasyPayStrategy: implements IPaymentGateway

3. CONTEXT
   - PaymentService: ‡πÉ‡∏ä‡πâ strategy ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

4. FACTORY
   - PaymentGatewayFactory: ‡∏™‡∏£‡πâ‡∏≤‡∏á strategy ‡∏ï‡∏≤‡∏° type

================================================================================
                                WEBHOOK CALLBACKS
================================================================================

1. BIB-PAY CALLBACK (Payin)
   {
     "status": "completed",
     "message": null,
     "data": {
       "transactionId": "TRX-BIBBYE-1754223377-7DSoI",
       "refferend": "trx-001",
       "amount": "1.00",
       "bank": {
         "name": "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢",
         "shortCode": "KTB",
         "code": "006"
       },
       "bnakNumber": "4550292199",
       "name": "test test",
       "depositAmount": "1.84"
     }
   }

2. BIB-PAY CALLBACK (Payout)
   {
     "status": "completed",
     "message": "‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
     "data": {
       "transactionId": "TRX-BIBBYE-1754223657-dqHBG",
       "refferend": "trx-001",
       "amount": "2.00",
       "bank": {
         "name": "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢",
         "shortCode": "KTB",
         "code": "006"
       },
       "bnakNumber": "4550292199",
       "name": "test test"
     }
   }

================================================================================
                                STATUS VALUES
================================================================================

1. DEPOSIT STATUS
   - "pending": ‡∏£‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤
   - "completed": ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
   - "timeout": ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤

2. WITHDRAW STATUS
   - "pending": ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÇ‡∏≠‡∏ô
   - "completed": ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
   - "fail": ‡πÇ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

================================================================================
                                ENVIRONMENT VARIABLES
================================================================================

BIBPAY_API_KEY=your-bibpay-api-key
EASYPAY_API_KEY=your-easypay-api-key
DATABASE_URL=postgresql://user:password@host:port/database
JWT_SECRET=your-jwt-secret
NODE_ENV=development

================================================================================
                                ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
================================================================================

src/
‚îú‚îÄ‚îÄ payment/                    # Payment Module
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/            # Interfaces ‡πÅ‡∏•‡∏∞ Types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment-gateway.interface.ts
‚îÇ   ‚îú‚îÄ‚îÄ strategies/            # Strategy Classes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bibpay.strategy.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ easypay.strategy.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/              # Services
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ controllers/           # Controllers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.controller.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ payment.module.ts      # Payment module config

================================================================================
                                ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤
================================================================================

Phase 1: ‚úÖ Database Schema (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
Phase 2: üîÑ Strategy Pattern Implementation
Phase 3: ‚è≥ Services & Controllers
Phase 4: ‚è≥ API Endpoints
Phase 5: ‚è≥ Webhook Handlers
Phase 6: ‚è≥ Testing & Integration

================================================================================
                                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
================================================================================

1. ref_code = transaction_id (‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
2. Easy-Pay ‡πÑ‡∏°‡πà‡∏°‡∏µ Balance ‡πÅ‡∏•‡∏∞ Banks API
3. BIB-Pay ‡πÉ‡∏ä‡πâ API Key, Easy-Pay ‡πÉ‡∏ä‡πâ Bearer Token
4. Webhook ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á CAS ‡∏ó‡∏µ‡πà callbackUrl ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤
5. ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Strategy Pattern ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Payment Gateway ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß

================================================================================
                                ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
================================================================================

‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤

================================================================================
                                ‡∏à‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
================================================================================
