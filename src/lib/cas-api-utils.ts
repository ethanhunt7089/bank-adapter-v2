import axios from "axios";

export interface CasLoginRequest {
  username: string;
  password: string;
}

export interface CasLoginResponse {
  access_token: string;
  profile: {
    id: number;
    username: string;
    role: string;
    first_name: string;
    last_name: string;
    is_active: boolean;
    created_at: string;
    updated_at: string;
    is_two_factor_enabled: boolean;
  };
}

export interface CasApiConfig {
  casUser: string;
  casPassword: string;
  targetDomain?: string; // ‡πÄ‡∏ä‡πà‡∏ô https://chok369.xyz (optional)
  casApiBase?: string; // ‡πÄ‡∏ä‡πà‡∏ô https://cas.chok369.xyz (‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô targetDomain)
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á domain ‡∏à‡∏≤‡∏Å https://chok369.xyz ‡πÄ‡∏õ‡πá‡∏ô https://cas.chok369.xyz
 * @param targetDomain - Domain ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô https://chok369.xyz
 * @returns CAS API URL ‡πÄ‡∏ä‡πà‡∏ô https://cas.chok369.xyz
 */
export function getCasApiUrl(targetDomain: string): string {
  try {
    const url = new URL(targetDomain);
    const hostname = url.hostname; // chok369.xyz

    // ‡πÅ‡∏¢‡∏Å domain ‡∏´‡∏•‡∏±‡∏Å
    const domainParts = hostname.split(".");
    const mainDomain = domainParts.slice(-2).join("."); // chok369.xyz

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á CAS URL
    const casUrl = `${url.protocol}//cas.${mainDomain}`;

    return casUrl;
  } catch (error) {
    throw new Error(`Invalid target domain: ${targetDomain}`);
  }
}

/**
 * Login ‡πÑ‡∏õ‡∏ó‡∏µ‡πà CAS API ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö access_token
 * @param config - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö login
 * @returns access_token ‡πÅ‡∏•‡∏∞ profile
 */
export async function loginToCas(
  config: CasApiConfig
): Promise<CasLoginResponse> {
  try {
    // ‡πÉ‡∏ä‡πâ casApiBase ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∂‡∏á‡πÉ‡∏ä‡πâ targetDomain
    const casApiUrl = config.casApiBase || getCasApiUrl(config.targetDomain);
    const loginUrl = `${casApiUrl}/admin/login`;

    const loginData: CasLoginRequest = {
      username: config.casUser,
      password: config.casPassword,
    };

    console.log(`Attempting CAS login to: ${loginUrl}`);
    console.log(`Username: ${config.casUser}`);

    const response = await axios.post<CasLoginResponse>(loginUrl, loginData, {
      headers: {
        "Content-Type": "application/json",
        "User-Agent": "Bank-Adapter-v2/1.0",
      },
      timeout: 10000, // 10 seconds timeout
    });

    if (response.status !== 200 && response.status !== 201) {
      throw new Error(`CAS login failed with status: ${response.status}`);
    }

    console.log(`‚úÖ CAS login successful for ${config.casUser}`);
    console.log(
      `Access token: ${response.data.access_token.substring(0, 20)}...`
    );

    return response.data;
  } catch (error) {
    console.error(`‚ùå CAS login failed:`, error.message);

    if (axios.isAxiosError(error)) {
      if (error.response) {
        // Server responded with error status
        console.error(
          `Server error: ${error.response.status} - ${error.response.statusText}`
        );
        console.error(`Response data:`, error.response.data);
        throw new Error(
          `CAS API error: ${error.response.status} - ${error.response.data?.message || error.response.statusText}`
        );
      } else if (error.request) {
        // Request was made but no response received
        console.error(`No response received from CAS API`);
        throw new Error("CAS API unreachable");
      }
    }

    throw error;
  }
}

/**
 * ‡∏™‡πà‡∏á callback ‡πÑ‡∏õ‡∏¢‡∏±‡∏á CAS API ‡∏î‡πâ‡∏ß‡∏¢ access_token
 * @param callbackUrl - URL ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á callback ‡πÑ‡∏õ
 * @param callbackData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
 * @param accessToken - access_token ‡∏à‡∏≤‡∏Å CAS login
 */
export async function sendCallbackToCas(
  callbackUrl: string,
  callbackData: any,
  accessToken: string
): Promise<void> {
  try {
    console.log(`Sending callback to CAS: ${callbackUrl}`);
    console.log(`Callback data:`, JSON.stringify(callbackData, null, 2));

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏≠ response (fire and forget)
    axios
      .post(callbackUrl, callbackData, {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${accessToken}`,
          "User-Agent": "Bank-Adapter-v2/1.0",
        },
        timeout: 5000, // 5 seconds timeout
      })
      .then((response) => {
        console.log(
          `‚úÖ Callback sent successfully to CAS, Status: ${response.status}`
        );
      })
      .catch((error) => {
        console.error(`‚ùå Failed to send callback to CAS:`, error.message);
        if (axios.isAxiosError(error)) {
          if (error.response) {
            console.error(
              `Server error: ${error.response.status} - ${error.response.statusText}`
            );
            console.error(`Response data:`, error.response.data);
          }
        }
      });

    console.log(`üì§ Callback request sent to CAS (fire and forget)`);
  } catch (error) {
    console.error(`‚ùå Failed to send callback to CAS:`, error.message);
    // ‡πÑ‡∏°‡πà throw error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ webhook ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
  }
}

/**
 * Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô CAS API ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£
 * @param config - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö login
 * @param callbackUrl - URL ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á callback ‡πÑ‡∏õ
 * @param callbackData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
 */
export async function handleCasCallback(
  config: CasApiConfig,
  callbackUrl: string,
  callbackData: any
): Promise<void> {
  try {
    // 1. Login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ access_token
    const loginResponse = await loginToCas(config);
    const accessToken = loginResponse.access_token;

    // 2. ‡∏™‡πà‡∏á callback ‡πÑ‡∏õ‡∏¢‡∏±‡∏á CAS
    await sendCallbackToCas(callbackUrl, callbackData, accessToken);

    console.log(`‚úÖ CAS callback completed successfully`);
  } catch (error) {
    console.error(`‚ùå CAS callback failed:`, error.message);
    throw error;
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö target account number ‡∏Å‡∏±‡∏ö CAS API /banks
 * @param targetDomain - Domain ‡∏Ç‡∏≠‡∏á CAS API
 * @param accessToken - access_token ‡∏à‡∏≤‡∏Å CAS login
 * @param targetAccNum - ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
 * @returns true ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, false ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
 */
export async function validateTargetAccountWithBanks(
  targetDomain: string,
  accessToken: string,
  targetAccNum: string
): Promise<{ isValid: boolean; bankInfo?: any; message?: string }> {
  try {
    const casApiUrl = getCasApiUrl(targetDomain);
    const banksUrl = `${casApiUrl}/banks`;

    console.log(
      `üîç Validating target account ${targetAccNum} with CAS banks API`
    );
    console.log(`Banks API URL: ${banksUrl}`);

    const response = await axios.get(banksUrl, {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
        "User-Agent": "Bank-Adapter-v2/1.0",
      },
      timeout: 10000, // 10 seconds timeout
    });

    if (response.status !== 200) {
      return {
        isValid: false,
        message: `Banks API returned status: ${response.status}`,
      };
    }

    const banksResponse = response.data;
    const banks = banksResponse.data || banksResponse; // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á {data: [...]} ‡πÅ‡∏•‡∏∞ [...]

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ banks ‡πÄ‡∏õ‡πá‡∏ô array ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!Array.isArray(banks)) {
      console.error(`‚ùå Banks data is not an array:`, typeof banks);
      return {
        isValid: false,
        message: "Invalid banks data format",
      };
    }

    console.log(`üìä Received ${banks.length} banks from CAS`);

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö targetAccNum (‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå)
    const foundBank = banks.find((bank: any) => {
      return (
        bank.phone_number === targetAccNum &&
        bank.is_show === true &&
        bank.is_enable_deposit === true
      );
    });

    if (foundBank) {
      console.log(`‚úÖ Found target account ${targetAccNum} in CAS banks`);
      console.log(`Bank info:`, JSON.stringify(foundBank, null, 2));
      return {
        isValid: true,
        bankInfo: foundBank,
      };
    } else {
      console.warn(`‚ùå Target account ${targetAccNum} not found in CAS banks`);
      return {
        isValid: false,
        message: `Target account ${targetAccNum} not found in CAS banks`,
      };
    }
  } catch (error) {
    console.error(
      `‚ùå Error validating target account with banks API:`,
      error.message
    );

    if (axios.isAxiosError(error)) {
      if (error.response) {
        console.error(
          `Server error: ${error.response.status} - ${error.response.statusText}`
        );
        console.error(`Response data:`, error.response.data);
        return {
          isValid: false,
          message: `Banks API error: ${error.response.status} - ${error.response.statusText}`,
        };
      } else if (error.request) {
        console.error(`No response received from banks API`);
        return {
          isValid: false,
          message: "Banks API unreachable",
        };
      }
    }

    return {
      isValid: false,
      message: `Validation error: ${error.message}`,
    };
  }
}
